<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-Affine" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/03/31/Affine/" class="article-date">
  <time class="dt-published" datetime="2023-03-31T11:06:39.158Z" itemprop="datePublished">2023-03-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><ul>
<li>简单来说就是利用加密函数将一个字母映射为另一个字母</li>
</ul>
<h3 id="加密函数"><a href="#加密函数" class="headerlink" title="加密函数"></a>加密函数</h3><h4 id="E-x-x3D-ax-b-n-其中"><a href="#E-x-x3D-ax-b-n-其中" class="headerlink" title="E(x) &#x3D; (ax+b)%n,其中"></a>E(x) &#x3D; (ax+b)%n,其中</h4><ul>
<li>n为所设置的字母编码表的大小</li>
<li>a,b为自选数，只要满足a与n互质即可</li>
<li>x为明文编码后的数字</li>
</ul>
<h3 id="解密函数"><a href="#解密函数" class="headerlink" title="解密函数"></a>解密函数</h3><h4 id="D-x-x3D-a-1-x-b-n"><a href="#D-x-x3D-a-1-x-b-n" class="headerlink" title="D(x) &#x3D; a-1(x-b)%n"></a>D(x) &#x3D; a-1(x-b)%n</h4><ul>
<li>a-1是a在Zn群的乘法逆元</li>
</ul>
<blockquote>
<p>乘法逆元这个东西等后续完全搞懂了再解释，主要的一点是满足a-1*a%n&#x3D;1</p>
</blockquote>
<h2 id="例题-BITSCTF2017-fanfie"><a href="#例题-BITSCTF2017-fanfie" class="headerlink" title="例题 [BITSCTF2017]fanfie"></a>例题 [BITSCTF2017]fanfie</h2><blockquote>
<p>Brute and get the base 32 format of flag.<br>encrypted.txt: MZYVMIWLGBL7CIJOGJQVOA3IN5BLYC3NHI</p>
</blockquote>
<h3 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h3><p>题目是一如既往的简洁<br>首先题目告诉我们有base32编码<br>同时由题目来源可知flag格式为BITSCTF{}</p>
<p>接下来就是玄学猜想:<br>编码后变长了，或许刚好和题目给的密文等长吧，考虑单表加密<br>I变M，J变Z，E变Y，很明显没直接的映射规律，考虑<a target="_blank" rel="noopener" href="http://woodenmandu.cn/2022/09/06/Affine/">仿射密码</a></p>
<p>下一步计算a，b</p>
<blockquote>
<p>别忘记这是base32，加密函数为E(x) &#x3D; (ax+b)%32</p>
</blockquote>
<ul>
<li><p>小算一下，拿两组数据：</p>
<blockquote>
<p>8(I)–&gt;12(M)<br>9(J)–&gt;25(Z)</p>
</blockquote>
</li>
<li><p>函数差值搞一下：25-12&#x3D;(9-1)a<br>a&#x3D;13，b顺理成章等于4</p>
</li>
<li><p>然后google找个求逆元的网站得到逆元等于5<br>得到解密函数D(x) &#x3D; 5(x-4)%32</p>
</li>
</ul>
<p>通过解密得到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">密文：MZYVMIWLGBL7CIJOGJQVOA3IN5BLYC3NHI</span><br><span class="line">明文：IJEVIU2DKRDHWUZSKZ4VSMTUN5RDEWTNPU</span><br></pre></td></tr></table></figure>

<p>最后base32解码就能得到flag:</p>
<blockquote>
<p>BITSCTF{S2VyY2tob2Zm}</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/03/31/Affine/" data-id="clfwpfz570000vws43l460dho" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Crypto" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/03/31/Crypto/" class="article-date">
  <time class="dt-published" datetime="2023-03-31T11:06:13.694Z" itemprop="datePublished">2023-03-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>## Base家族</p>
<h4 id="base16"><a href="#base16" class="headerlink" title="base16"></a>base16</h4><ul>
<li>16进制，只包含（[0-9], [A-F]）</li>
</ul>
<h4 id="base32"><a href="#base32" class="headerlink" title="base32"></a>base32</h4><ul>
<li>（[A-Z],[2-7]）,一般来讲密文字母多于数字，而且末尾有多个等号</li>
</ul>
<h4 id="base58"><a href="#base58" class="headerlink" title="base58"></a>base58</h4><ul>
<li>结尾无等号</li>
</ul>
<h4 id="base64"><a href="#base64" class="headerlink" title="base64"></a>base64</h4><ul>
<li>（[A-Z],[a-z],[0-9]），末尾有1到2个等号</li>
<li>8位变6位重组</li>
</ul>
<h4 id="base85"><a href="#base85" class="headerlink" title="base85"></a>base85</h4><ul>
<li>等号可能出现在密文中间</li>
</ul>
<h4 id="base91"><a href="#base91" class="headerlink" title="base91"></a>base91</h4><ul>
<li>（[0-9]，[a-z]，[A-Z],[!#$%&amp;()*+,.&#x2F;:;&lt;&#x3D;&gt;?@[]^_&#96;{|}~”]）</li>
</ul>
<h4 id="base100"><a href="#base100" class="headerlink" title="base100"></a>base100</h4><ul>
<li>密文为emjio</li>
</ul>
<h2 id="幂数加密"><a href="#幂数加密" class="headerlink" title="幂数加密"></a>幂数加密</h2><h3 id="加密方法"><a href="#加密方法" class="headerlink" title="加密方法"></a>加密方法</h3><ul>
<li>由于每一个数都可以变成形式为”2a+2b+2c….”的表达式<br>所以我们用对应”abc…”数字串来代表这个数</li>
<li>例如<br>5 &#x3D; 20+22，即可表示为02<br>19 &#x3D; 20+21+24，即014</li>
</ul>
<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><blockquote>
<p>8842101220480224404014224202480122</p>
</blockquote>
<ul>
<li>是8位大写字母</li>
<li>采用幂数加密</li>
</ul>
<h3 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h3><ul>
<li><p>联想8位字母和8个0的字符串，猜测以0为分隔符<br>拆分后可以得到：</p>
<blockquote>
<p>88421 122 48 2244 4 142242 248 122</p>
</blockquote>
</li>
<li><p>观察发现每个数字都是2的倍数，推断单个数字表示的就是”2a“，所以将每一段数字直接求和</p>
</li>
<li><p>上脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;iostream&gt;</span><br><span class="line">using namespace std;</span><br><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">	string s = &quot;88421 122 48 2244 4 142242 248 122 &quot;; </span><br><span class="line">	int sum = 0;</span><br><span class="line">	for(int i = 0; i &lt; s.length(); i++)&#123;</span><br><span class="line">		if(s[i] == &#x27; &#x27;)&#123;</span><br><span class="line">			cout &lt;&lt;char(sum+&#x27;A&#x27;-1);</span><br><span class="line">			sum = 0;</span><br><span class="line">		&#125;</span><br><span class="line">		else&#123;</span><br><span class="line">			sum += (s[i]-&#x27;0&#x27;);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>得到flag：</p>
<blockquote>
<p>cyberpace{WELLDONE}</p>
</blockquote>
</li>
</ul>
<h2 id="猪圈密码"><a href="#猪圈密码" class="headerlink" title="猪圈密码"></a>猪圈密码</h2><ul>
<li><p>特征：</p>
<p><img src="https://s2.loli.net/2022/11/10/NcQI8HopdEwVzy9.jpg" alt="Crypto_Pig.jpg"></p>
</li>
<li><p>解密网站：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://xiao84.com/tools/103177.html">猪圈密码-在线解密加密工具 (xiao84.com)</a></li>
</ul>
</li>
</ul>
<h2 id="emjio-AES"><a href="#emjio-AES" class="headerlink" title="emjio-AES"></a>emjio-AES</h2><ul>
<li>加密过程就是将一段字符串用key和rotation进行AES加密，然后将输出的base64码用表情包替换，特征只能靠猜和hint了</li>
<li>解密网站：<ul>
<li><a target="_blank" rel="noopener" href="https://aghorler.github.io/emoji-aes/">emoji-aes (aghorler.github.io)</a></li>
</ul>
</li>
<li>涉及题目<ul>
<li>ISCTF2022 可爱的emjio</li>
</ul>
</li>
</ul>
<h2 id="佛曰加密"><a href="#佛曰加密" class="headerlink" title="佛曰加密"></a>佛曰加密</h2><ul>
<li>特征：“諸隸毘僧降毘吽諸陀毘摩毘隸僧毘缽薩毘願心毘婆毘嚴彌毘念毘如毘囑毘” 一堆古怪文字</li>
<li>解密网站：<ul>
<li><a target="_blank" rel="noopener" href="http://hi.pcmoe.net/Buddha.html">新约佛论禅&#x2F;佛曰加密 - PcMoe!</a></li>
</ul>
</li>
</ul>
<h2 id="天干地支加密"><a href="#天干地支加密" class="headerlink" title="天干地支加密"></a>天干地支加密</h2><ul>
<li>特征：利用纪年法对应加密数字</li>
<li>解密：查表</li>
<li>涉及题目：<ul>
<li>[MRCTF]天干地支+甲子</li>
</ul>
</li>
</ul>
<h2 id="社会主义核心价值观加密"><a href="#社会主义核心价值观加密" class="headerlink" title="社会主义核心价值观加密"></a>社会主义核心价值观加密</h2><ul>
<li>特征：顾名思义</li>
<li>解密网站：<ul>
<li><a target="_blank" rel="noopener" href="http://www.atoolbox.net/Tool.php?Id=850">社会主义核心价值观加密&#x2F;解密 - 一个工具箱 - 好用的在线工具都在这里！ (atoolbox.net)</a></li>
</ul>
</li>
</ul>
<h2 id="jsfuck编码"><a href="#jsfuck编码" class="headerlink" title="jsfuck编码"></a>jsfuck编码</h2><ul>
<li><p>特征：由()+ []! 六个字符组成编码</p>
</li>
<li><p>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">false	==&gt;	![]</span><br><span class="line">true	=&gt;	!![]</span><br><span class="line">undefined	=&gt;	[][[]]</span><br><span class="line">NaN	=&gt;	+[![]]</span><br><span class="line">0	=&gt;	+[]</span><br><span class="line">1	=&gt;	+!+[]</span><br><span class="line">2	=&gt;	!+[]+!+[]</span><br><span class="line">10	=&gt;	[+!+[]]+[+[]]</span><br><span class="line">Array	=&gt;	[]</span><br><span class="line">Number	=&gt;	+[]</span><br><span class="line">String	=&gt;	[]+[]</span><br><span class="line">Boolean	=&gt;	![]</span><br><span class="line">Function	=&gt;	[][&quot;filter&quot;]</span><br><span class="line">eval	=&gt;	[][&quot;filter&quot;][&quot;constructor&quot;]( CODE )()</span><br><span class="line">window	=&gt;	[][&quot;filter&quot;][&quot;constructor&quot;](&quot;return this&quot;)()</span><br></pre></td></tr></table></figure>
</li>
<li><p>解密网站：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.bugku.com/tools/jsfuck">https://www.bugku.com/tools/jsfuck</a></li>
<li><a target="_blank" rel="noopener" href="https://www.dejs.vip/encry_decry/jsfuck.html">jsfuck加密&#x2F;解密 - dejs.vip</a></li>
</ul>
</li>
<li><p>涉及题目：</p>
<ul>
<li>buuctf - 这是什么</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/03/31/Crypto/" data-id="clfwpfz5l0008vws46c3igcsa" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Flat" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/03/31/Flat/" class="article-date">
  <time class="dt-published" datetime="2023-03-31T11:04:58.987Z" itemprop="datePublished">2023-03-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="解题流程"><a href="#解题流程" class="headerlink" title="解题流程"></a>解题流程</h2><ol>
<li>查壳IDA</li>
<li>脚本去平坦化</li>
<li>IDA脚本去混淆</li>
<li>CRC32识别</li>
<li>解密脚本</li>
</ol>
<h2 id="脚本集"><a href="#脚本集" class="headerlink" title="脚本集"></a>脚本集</h2><ul>
<li><p>去平坦化脚本</p>
<ul>
<li><p>命令：</p>
<blockquote>
<p>python deflat.py attachment 0x400620</p>
</blockquote>
</li>
<li><p>deflat</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> pyvex</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.path.append(<span class="string">&#x27;C:\\Users\\du\\Desktop\\CTFTools\\Flat\\am_graph&#x27;</span>)  <span class="comment">## am_graph路径</span></span><br><span class="line"><span class="keyword">import</span> am_graph</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.getLogger(<span class="string">&#x27;angr.state_plugins.symbolic_memory&#x27;</span>).setLevel(logging.ERROR)</span><br><span class="line"><span class="comment"># logging.getLogger(&#x27;angr.sim_manager&#x27;).setLevel(logging.DEBUG)</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_relevant_nop_nodes</span>(<span class="params">supergraph</span>):</span><br><span class="line">    <span class="keyword">global</span> pre_dispatcher_node, prologue_node, retn_node</span><br><span class="line">    <span class="comment"># relevant_nodes = list(supergraph.predecessors(pre_dispatcher_node))</span></span><br><span class="line">    relevant_nodes = []</span><br><span class="line">    nop_nodes = []</span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> supergraph.nodes():</span><br><span class="line">        <span class="keyword">if</span> supergraph.has_edge(node, pre_dispatcher_node) <span class="keyword">and</span> node.size &gt; <span class="number">8</span>:</span><br><span class="line">            <span class="comment"># <span class="doctag">XXX:</span> use node.size is faster than to create a block </span></span><br><span class="line">            relevant_nodes.append(node)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> node.addr <span class="keyword">in</span> ( prologue_node.addr, retn_node.addr, pre_dispatcher_node.addr):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        nop_nodes.append(node)</span><br><span class="line">    <span class="keyword">return</span> relevant_nodes, nop_nodes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">symbolic_execution</span>(<span class="params">start_addr, hook_addr=<span class="literal">None</span>, modify=<span class="literal">None</span>, inspect=<span class="literal">False</span></span>):</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retn_procedure</span>(<span class="params">state</span>):</span><br><span class="line">        <span class="keyword">global</span> project</span><br><span class="line">        ip = state.se.<span class="built_in">eval</span>(state.regs.ip)</span><br><span class="line">        project.unhook(ip)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">statement_inspect</span>(<span class="params">state</span>):</span><br><span class="line">        <span class="keyword">global</span> modify_value</span><br><span class="line">        expressions = <span class="built_in">list</span>(state.scratch.irsb.statements[state.inspect.statement].expressions)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(expressions) != <span class="number">0</span> <span class="keyword">and</span> <span class="built_in">isinstance</span>(expressions[<span class="number">0</span>], pyvex.expr.ITE):</span><br><span class="line">            state.scratch.temps[expressions[<span class="number">0</span>].cond.tmp] = modify_value</span><br><span class="line">            state.inspect._breakpoints[<span class="string">&#x27;statement&#x27;</span>] = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">global</span> project, relevant_block_addrs, modify_value</span><br><span class="line">    <span class="keyword">if</span> hook_addr != <span class="literal">None</span>:</span><br><span class="line">        project.hook(hook_addr, retn_procedure, length=<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">if</span> modify != <span class="literal">None</span>:</span><br><span class="line">        modify_value = modify</span><br><span class="line">    state = project.factory.blank_state(addr=start_addr, remove_options=&#123;angr.sim_options.LAZY_SOLVES&#125;)</span><br><span class="line">    <span class="keyword">if</span> inspect:</span><br><span class="line">        state.inspect.b(<span class="string">&#x27;statement&#x27;</span>, when=angr.state_plugins.inspect.BP_BEFORE, action=statement_inspect)</span><br><span class="line">    sm = project.factory.simulation_manager(state)</span><br><span class="line">    sm.step()</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(sm.active) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> active_state <span class="keyword">in</span> sm.active:</span><br><span class="line">            <span class="keyword">if</span> active_state.addr <span class="keyword">in</span> relevant_block_addrs:</span><br><span class="line">                <span class="keyword">return</span> active_state.addr</span><br><span class="line">        sm.step()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill_nop</span>(<span class="params">data, start_addr, length</span>):</span><br><span class="line">    <span class="keyword">global</span> opcode</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, length):</span><br><span class="line">        data[start_addr + i] = <span class="built_in">ord</span>(opcode[<span class="string">&#x27;nop&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill_jmp_offset</span>(<span class="params">data, start, offset</span>):</span><br><span class="line">    jmp_offset = struct.pack(<span class="string">&#x27;&lt;i&#x27;</span>, offset)  <span class="comment"># bytes</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        data[start + i] = jmp_offset[i]</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">patch_byte</span>(<span class="params">data, offset, value</span>):</span><br><span class="line">    <span class="comment"># operate on bytearray, not str</span></span><br><span class="line">    data[offset] = <span class="built_in">ord</span>(value)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">3</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Usage: python deflat.py filename function_address(hex)&#x27;</span>)</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    opcode = &#123;<span class="string">&#x27;a&#x27;</span>:<span class="string">&#x27;\x87&#x27;</span>, <span class="string">&#x27;ae&#x27;</span>: <span class="string">&#x27;\x83&#x27;</span>, <span class="string">&#x27;b&#x27;</span>:<span class="string">&#x27;\x82&#x27;</span>, <span class="string">&#x27;be&#x27;</span>:<span class="string">&#x27;\x86&#x27;</span>, <span class="string">&#x27;c&#x27;</span>:<span class="string">&#x27;\x82&#x27;</span>, <span class="string">&#x27;e&#x27;</span>:<span class="string">&#x27;\x84&#x27;</span>, <span class="string">&#x27;z&#x27;</span>:<span class="string">&#x27;\x84&#x27;</span>, <span class="string">&#x27;g&#x27;</span>:<span class="string">&#x27;\x8F&#x27;</span>, </span><br><span class="line">              <span class="string">&#x27;ge&#x27;</span>:<span class="string">&#x27;\x8D&#x27;</span>, <span class="string">&#x27;l&#x27;</span>:<span class="string">&#x27;\x8C&#x27;</span>, <span class="string">&#x27;le&#x27;</span>:<span class="string">&#x27;\x8E&#x27;</span>, <span class="string">&#x27;na&#x27;</span>:<span class="string">&#x27;\x86&#x27;</span>, <span class="string">&#x27;nae&#x27;</span>:<span class="string">&#x27;\x82&#x27;</span>, <span class="string">&#x27;nb&#x27;</span>:<span class="string">&#x27;\x83&#x27;</span>, <span class="string">&#x27;nbe&#x27;</span>:<span class="string">&#x27;\x87&#x27;</span>, <span class="string">&#x27;nc&#x27;</span>:<span class="string">&#x27;\x83&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;ne&#x27;</span>:<span class="string">&#x27;\x85&#x27;</span>, <span class="string">&#x27;ng&#x27;</span>:<span class="string">&#x27;\x8E&#x27;</span>, <span class="string">&#x27;nge&#x27;</span>:<span class="string">&#x27;\x8C&#x27;</span>, <span class="string">&#x27;nl&#x27;</span>:<span class="string">&#x27;\x8D&#x27;</span>, <span class="string">&#x27;nle&#x27;</span>:<span class="string">&#x27;\x8F&#x27;</span>, <span class="string">&#x27;no&#x27;</span>:<span class="string">&#x27;\x81&#x27;</span>, <span class="string">&#x27;np&#x27;</span>:<span class="string">&#x27;\x8B&#x27;</span>, <span class="string">&#x27;ns&#x27;</span>:<span class="string">&#x27;\x89&#x27;</span>,</span><br><span class="line">              <span class="string">&#x27;nz&#x27;</span>:<span class="string">&#x27;\x85&#x27;</span>, <span class="string">&#x27;o&#x27;</span>:<span class="string">&#x27;\x80&#x27;</span>, <span class="string">&#x27;p&#x27;</span>:<span class="string">&#x27;\x8A&#x27;</span>, <span class="string">&#x27;pe&#x27;</span>:<span class="string">&#x27;\x8A&#x27;</span>, <span class="string">&#x27;po&#x27;</span>:<span class="string">&#x27;\x8B&#x27;</span>, <span class="string">&#x27;s&#x27;</span>:<span class="string">&#x27;\x88&#x27;</span>, <span class="string">&#x27;nop&#x27;</span>:<span class="string">&#x27;\x90&#x27;</span>, <span class="string">&#x27;jmp&#x27;</span>:<span class="string">&#x27;\xE9&#x27;</span>, <span class="string">&#x27;j&#x27;</span>:<span class="string">&#x27;\x0F&#x27;</span>&#125;</span><br><span class="line">    </span><br><span class="line">    filename = sys.argv[<span class="number">1</span>]</span><br><span class="line">    start = <span class="built_in">int</span>(sys.argv[<span class="number">2</span>], <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    project = angr.Project(filename, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">    cfg = project.analyses.CFGFast(normalize=<span class="literal">True</span>)  <span class="comment"># do normalize to avoid overlapping blocks</span></span><br><span class="line">    target_function = cfg.functions.get(start)</span><br><span class="line">    <span class="comment"># A super transition graph is a graph that looks like IDA Pro&#x27;s CFG</span></span><br><span class="line">    supergraph = am_graph.to_supergraph(target_function.transition_graph)</span><br><span class="line"></span><br><span class="line">    base_addr = project.loader.main_object.mapped_base &gt;&gt; <span class="number">12</span> &lt;&lt; <span class="number">12</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get prologue_node and retn_node</span></span><br><span class="line">    prologue_node = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> supergraph.nodes():</span><br><span class="line">        <span class="keyword">if</span> supergraph.in_degree(node) == <span class="number">0</span>:</span><br><span class="line">            prologue_node = node</span><br><span class="line">        <span class="keyword">if</span> supergraph.out_degree(node) == <span class="number">0</span>:</span><br><span class="line">            retn_node = node</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> prologue_node <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> prologue_node.addr != start:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Something must be wrong...&quot;</span>)</span><br><span class="line">        sys.exit(-<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    main_dispatcher_node = <span class="built_in">list</span>(supergraph.successors(prologue_node))[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> supergraph.predecessors(main_dispatcher_node):</span><br><span class="line">        <span class="keyword">if</span> node.addr != prologue_node.addr:</span><br><span class="line">            pre_dispatcher_node = node</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    relevant_nodes, nop_nodes = get_relevant_nop_nodes(supergraph)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;*******************relevant blocks************************&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;prologue: %#x&#x27;</span> % start)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;main_dispatcher: %#x&#x27;</span> % main_dispatcher_node.addr)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;pre_dispatcher: %#x&#x27;</span> % pre_dispatcher_node.addr)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;retn: %#x&#x27;</span> % retn_node.addr)</span><br><span class="line">    relevant_block_addrs = [node.addr <span class="keyword">for</span> node <span class="keyword">in</span> relevant_nodes]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;relevant_blocks:&#x27;</span>, [<span class="built_in">hex</span>(addr) <span class="keyword">for</span> addr <span class="keyword">in</span> relevant_block_addrs])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;*******************symbolic execution*********************&#x27;</span>)</span><br><span class="line">    relevants = relevant_nodes</span><br><span class="line">    relevants.append(prologue_node)</span><br><span class="line">    relevants_without_retn = <span class="built_in">list</span>(relevants)</span><br><span class="line">    relevants.append(retn_node)</span><br><span class="line">    relevant_block_addrs.extend([prologue_node.addr, retn_node.addr])</span><br><span class="line"></span><br><span class="line">    flow = defaultdict(<span class="built_in">list</span>)</span><br><span class="line">    modify_value = <span class="literal">None</span></span><br><span class="line">    patch_instrs = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> relevant <span class="keyword">in</span> relevants_without_retn:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;-------------------dse %#x---------------------&#x27;</span> % relevant.addr)</span><br><span class="line">        block = project.factory.block(relevant.addr, size=relevant.size)</span><br><span class="line">        has_branches = <span class="literal">False</span></span><br><span class="line">        hook_addr = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">for</span> ins <span class="keyword">in</span> block.capstone.insns:</span><br><span class="line">            <span class="keyword">if</span> ins.insn.mnemonic.startswith(<span class="string">&#x27;cmov&#x27;</span>):</span><br><span class="line">                patch_instrs[relevant] = ins</span><br><span class="line">                has_branches = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> ins.insn.mnemonic.startswith(<span class="string">&#x27;call&#x27;</span>):</span><br><span class="line">                hook_addr = ins.insn.address</span><br><span class="line">        <span class="keyword">if</span> has_branches:</span><br><span class="line">            flow[relevant].append(symbolic_execution(relevant.addr, hook_addr, claripy.BVV(<span class="number">1</span>, <span class="number">1</span>), <span class="literal">True</span>))</span><br><span class="line">            flow[relevant].append(symbolic_execution(relevant.addr, hook_addr, claripy.BVV(<span class="number">0</span>, <span class="number">1</span>), <span class="literal">True</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            flow[relevant].append(symbolic_execution(relevant.addr, hook_addr))</span><br><span class="line">            </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;************************flow******************************&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> flow.items():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%#x: &#x27;</span> % k.addr, [<span class="built_in">hex</span>(child) <span class="keyword">for</span> child <span class="keyword">in</span> v])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># print retn_node flow. Actually, it&#x27;s [].</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;%#x: &#x27;</span> % retn_node.addr, [])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;************************patch*****************************&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> origin:</span><br><span class="line">        <span class="comment"># Attention: can&#x27;t transform to str by calling decode() directly. so use bytearray instead.</span></span><br><span class="line">        origin_data = <span class="built_in">bytearray</span>(origin.read())</span><br><span class="line">        origin_data_len = <span class="built_in">len</span>(origin_data)</span><br><span class="line"></span><br><span class="line">    recovery_file = filename + <span class="string">&#x27;_recovered&#x27;</span></span><br><span class="line">    recovery = <span class="built_in">open</span>(recovery_file, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># patch irrelevant blocks</span></span><br><span class="line">    <span class="keyword">for</span> nop_node <span class="keyword">in</span> nop_nodes:</span><br><span class="line">        fill_nop(origin_data, nop_node.addr - base_addr, nop_node.size)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># remove unnecessary control flows</span></span><br><span class="line">    <span class="keyword">for</span> parent, childs <span class="keyword">in</span> flow.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(childs) == <span class="number">1</span>:</span><br><span class="line">            parent_block = project.factory.block(parent.addr, size=parent.size)</span><br><span class="line">            last_instr = parent_block.capstone.insns[-<span class="number">1</span>]</span><br><span class="line">            file_offset = last_instr.address - base_addr</span><br><span class="line">            <span class="comment"># patch the last jmp instruction</span></span><br><span class="line">            patch_byte(origin_data, file_offset, opcode[<span class="string">&#x27;jmp&#x27;</span>])</span><br><span class="line">            file_offset += <span class="number">1</span></span><br><span class="line">            fill_nop(origin_data, file_offset, last_instr.size - <span class="number">1</span>)</span><br><span class="line">            fill_jmp_offset(origin_data, file_offset, childs[<span class="number">0</span>] - last_instr.address - <span class="number">5</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            instr = patch_instrs[parent]</span><br><span class="line">            file_offset = instr.address - base_addr</span><br><span class="line">            <span class="comment"># patch instructions starting from `cmovx` to the end of block</span></span><br><span class="line">            fill_nop(origin_data, file_offset, parent.addr + parent.size - base_addr - file_offset)</span><br><span class="line">            patch_byte(origin_data, file_offset, opcode[<span class="string">&#x27;j&#x27;</span>])</span><br><span class="line">            patch_byte(origin_data, file_offset + <span class="number">1</span>, opcode[instr.mnemonic[<span class="number">4</span>:]])</span><br><span class="line">            fill_jmp_offset(origin_data, file_offset + <span class="number">2</span>, childs[<span class="number">0</span>] - instr.address - <span class="number">6</span>)</span><br><span class="line">            file_offset += <span class="number">6</span></span><br><span class="line">            patch_byte(origin_data, file_offset, opcode[<span class="string">&#x27;jmp&#x27;</span>])</span><br><span class="line">            fill_jmp_offset(origin_data, file_offset + <span class="number">1</span>, childs[<span class="number">1</span>] - (instr.address + <span class="number">6</span>) - <span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(origin_data) == origin_data_len, <span class="string">&quot;Error: size of data changed!!!&quot;</span></span><br><span class="line">    recovery.write(origin_data)</span><br><span class="line">    recovery.close()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Successful! The recovered file: %s&#x27;</span> % recovery_file)</span><br></pre></td></tr></table></figure>
</li>
<li><p>am_graph</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> networkx</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> angr.knowledge_plugins <span class="keyword">import</span> Function</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">grouper</span>(<span class="params">iterable, n, fillvalue=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;Collect data into fixed-length chunks or blocks&quot;</span></span><br><span class="line">    args = [<span class="built_in">iter</span>(iterable)] * n</span><br><span class="line">    <span class="keyword">return</span> itertools.izip_longest(*args, fillvalue=fillvalue)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">to_supergraph</span>(<span class="params">transition_graph</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Convert transition graph of a function to a super transition graph. A super transition graph is a graph that looks</span></span><br><span class="line"><span class="string">    like IDA Pro&#x27;s CFG, where calls to returning functions do not terminate basic blocks.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param networkx.DiGraph transition_graph: The transition graph.</span></span><br><span class="line"><span class="string">    :return: A converted super transition graph</span></span><br><span class="line"><span class="string">    :rtype networkx.DiGraph</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># make a copy of the graph</span></span><br><span class="line">    transition_graph = networkx.DiGraph(transition_graph)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># remove all edges that transitions to outside</span></span><br><span class="line">    <span class="keyword">for</span> src, dst, data <span class="keyword">in</span> <span class="built_in">list</span>(transition_graph.edges(data=<span class="literal">True</span>)):</span><br><span class="line">        <span class="keyword">if</span> data[<span class="string">&#x27;type&#x27;</span>] <span class="keyword">in</span> (<span class="string">&#x27;transition&#x27;</span>, <span class="string">&#x27;exception&#x27;</span>) <span class="keyword">and</span> data.get(<span class="string">&#x27;outside&#x27;</span>, <span class="literal">False</span>) <span class="keyword">is</span> <span class="literal">True</span>:</span><br><span class="line">            transition_graph.remove_edge(src, dst)</span><br><span class="line">        <span class="keyword">if</span> transition_graph.in_degree(dst) == <span class="number">0</span>:</span><br><span class="line">            transition_graph.remove_node(dst)</span><br><span class="line"></span><br><span class="line">    edges_to_shrink = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Find all edges to remove in the super graph</span></span><br><span class="line">    <span class="keyword">for</span> src <span class="keyword">in</span> transition_graph.nodes():</span><br><span class="line">        edges = transition_graph[src]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># there are two types of edges we want to remove:</span></span><br><span class="line">        <span class="comment"># - call or fakerets, since we do not want blocks to break at calls</span></span><br><span class="line">        <span class="comment"># - boring jumps that directly transfer the control to the block immediately after the current block. this is</span></span><br><span class="line">        <span class="comment">#   usually caused by how VEX breaks down basic blocks, which happens very often in MIPS</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(edges) == <span class="number">1</span> <span class="keyword">and</span> src.addr + src.size == <span class="built_in">next</span>(<span class="built_in">iter</span>(edges.keys())).addr:</span><br><span class="line">            dst = <span class="built_in">next</span>(<span class="built_in">iter</span>(edges.keys()))</span><br><span class="line">            dst_in_edges = transition_graph.in_edges(dst)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(dst_in_edges) == <span class="number">1</span>:</span><br><span class="line">                edges_to_shrink.add((src, dst))</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">any</span>(<span class="built_in">iter</span>(<span class="string">&#x27;type&#x27;</span> <span class="keyword">in</span> data <span class="keyword">and</span> data[<span class="string">&#x27;type&#x27;</span>] <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;fake_return&#x27;</span>, <span class="string">&#x27;call&#x27;</span>) <span class="keyword">for</span> data <span class="keyword">in</span> edges.values())):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> dst, data <span class="keyword">in</span> edges.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(dst, Function):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;type&#x27;</span> <span class="keyword">in</span> data <span class="keyword">and</span> data[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;fake_return&#x27;</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">all</span>(<span class="built_in">iter</span>(<span class="string">&#x27;type&#x27;</span> <span class="keyword">in</span> data <span class="keyword">and</span> data[<span class="string">&#x27;type&#x27;</span>] <span class="keyword">in</span> (<span class="string">&#x27;fake_return&#x27;</span>, <span class="string">&#x27;return_from_call&#x27;</span>)</span><br><span class="line">                            <span class="keyword">for</span> _, _, data <span class="keyword">in</span> transition_graph.in_edges(dst, data=<span class="literal">True</span>))):</span><br><span class="line">                    edges_to_shrink.add((src, dst))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create the super graph</span></span><br><span class="line">    super_graph = networkx.DiGraph()</span><br><span class="line"></span><br><span class="line">    supernodes_map = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    function_nodes = <span class="built_in">set</span>()  <span class="comment"># it will be traversed after all other nodes are added into the supergraph</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> transition_graph.nodes():</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(node, Function):</span><br><span class="line">            function_nodes.add(node)</span><br><span class="line">            <span class="comment"># don&#x27;t put functions into the supergraph</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        dests_and_data = transition_graph[node]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># make a super node</span></span><br><span class="line">        <span class="keyword">if</span> node <span class="keyword">in</span> supernodes_map:</span><br><span class="line">            src_supernode = supernodes_map[node]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            src_supernode = SuperCFGNode.from_cfgnode(node)</span><br><span class="line">            supernodes_map[node] = src_supernode</span><br><span class="line">            <span class="comment"># insert it into the graph</span></span><br><span class="line">            super_graph.add_node(src_supernode)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> dests_and_data:</span><br><span class="line">            <span class="comment"># might be an isolated node</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Take src_supernode off the graph since we might modify it</span></span><br><span class="line">        <span class="keyword">if</span> src_supernode <span class="keyword">in</span> super_graph:</span><br><span class="line">            existing_in_edges = <span class="built_in">list</span>(super_graph.in_edges(src_supernode, data=<span class="literal">True</span>))</span><br><span class="line">            existing_out_edges = <span class="built_in">list</span>(super_graph.out_edges(src_supernode, data=<span class="literal">True</span>))</span><br><span class="line">            super_graph.remove_node(src_supernode)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            existing_in_edges = [ ]</span><br><span class="line">            existing_out_edges = [ ]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> dst, data <span class="keyword">in</span> dests_and_data.items():</span><br><span class="line"></span><br><span class="line">            edge = (node, dst)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> edge <span class="keyword">in</span> edges_to_shrink:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> dst <span class="keyword">in</span> supernodes_map:</span><br><span class="line">                    dst_supernode = supernodes_map[dst]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    dst_supernode = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">                src_supernode.insert_cfgnode(dst)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># update supernodes map</span></span><br><span class="line">                supernodes_map[dst] = src_supernode</span><br><span class="line"></span><br><span class="line">                <span class="comment"># merge the other supernode</span></span><br><span class="line">                <span class="keyword">if</span> dst_supernode <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    src_supernode.merge(dst_supernode)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> src <span class="keyword">in</span> dst_supernode.cfg_nodes:</span><br><span class="line">                        supernodes_map[src] = src_supernode</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># link all out edges of dst_supernode to src_supernode</span></span><br><span class="line">                    <span class="keyword">for</span> dst_, data_ <span class="keyword">in</span> super_graph[dst_supernode].items():</span><br><span class="line">                        super_graph.add_edge(src_supernode, dst_, **data_)</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># link all in edges of dst_supernode to src_supernode</span></span><br><span class="line">                    <span class="keyword">for</span> src_, _, data_ <span class="keyword">in</span> super_graph.in_edges(dst_supernode, data=<span class="literal">True</span>):</span><br><span class="line">                        super_graph.add_edge(src_, src_supernode, **data_)</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> <span class="string">&#x27;type&#x27;</span> <span class="keyword">in</span> data_ <span class="keyword">and</span> data_[<span class="string">&#x27;type&#x27;</span>] <span class="keyword">in</span> (<span class="string">&#x27;transition&#x27;</span>, <span class="string">&#x27;exception&#x27;</span>):</span><br><span class="line">                            <span class="keyword">if</span> <span class="keyword">not</span> (<span class="string">&#x27;ins_addr&#x27;</span> <span class="keyword">in</span> data_ <span class="keyword">and</span> <span class="string">&#x27;stmt_idx&#x27;</span> <span class="keyword">in</span> data_):</span><br><span class="line">                                <span class="comment"># this is a hack to work around the issue in Function.normalize() where ins_addr and</span></span><br><span class="line">                                <span class="comment"># stmt_idx weren&#x27;t properly set onto edges</span></span><br><span class="line">                                <span class="keyword">continue</span></span><br><span class="line">                            src_supernode.register_out_branch(data_[<span class="string">&#x27;ins_addr&#x27;</span>], data_[<span class="string">&#x27;stmt_idx&#x27;</span>], data_[<span class="string">&#x27;type&#x27;</span>],</span><br><span class="line">                                                              dst_supernode.addr</span><br><span class="line">                                                              )</span><br><span class="line"></span><br><span class="line">                    super_graph.remove_node(dst_supernode)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(dst, Function):</span><br><span class="line">                    <span class="comment"># skip all functions</span></span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># make a super node</span></span><br><span class="line">                <span class="keyword">if</span> dst <span class="keyword">in</span> supernodes_map:</span><br><span class="line">                    dst_supernode = supernodes_map[dst]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    dst_supernode = SuperCFGNode.from_cfgnode(dst)</span><br><span class="line">                    supernodes_map[dst] = dst_supernode</span><br><span class="line"></span><br><span class="line">                super_graph.add_edge(src_supernode, dst_supernode, **data)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;type&#x27;</span> <span class="keyword">in</span> data <span class="keyword">and</span> data[<span class="string">&#x27;type&#x27;</span>] <span class="keyword">in</span> (<span class="string">&#x27;transition&#x27;</span>, <span class="string">&#x27;exception&#x27;</span>):</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> (<span class="string">&#x27;ins_addr&#x27;</span> <span class="keyword">in</span> data <span class="keyword">and</span> <span class="string">&#x27;stmt_idx&#x27;</span> <span class="keyword">in</span> data):</span><br><span class="line">                        <span class="comment"># this is a hack to work around the issue in Function.normalize() where ins_addr and</span></span><br><span class="line">                        <span class="comment"># stmt_idx weren&#x27;t properly set onto edges</span></span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    src_supernode.register_out_branch(data[<span class="string">&#x27;ins_addr&#x27;</span>], data[<span class="string">&#x27;stmt_idx&#x27;</span>], data[<span class="string">&#x27;type&#x27;</span>],</span><br><span class="line">                                                      dst_supernode.addr</span><br><span class="line">                                                      )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># add back the node (in case there are no edges)</span></span><br><span class="line">        super_graph.add_node(src_supernode)</span><br><span class="line">        <span class="comment"># add back the old edges</span></span><br><span class="line">        <span class="keyword">for</span> src, _, data <span class="keyword">in</span> existing_in_edges:</span><br><span class="line">            super_graph.add_edge(src, src_supernode, **data)</span><br><span class="line">        <span class="keyword">for</span> _, dst, data <span class="keyword">in</span> existing_out_edges:</span><br><span class="line">            super_graph.add_edge(src_supernode, dst, **data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> function_nodes:</span><br><span class="line">        in_edges = transition_graph.in_edges(node, data=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> src, _, data <span class="keyword">in</span> in_edges:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> (<span class="string">&#x27;ins_addr&#x27;</span> <span class="keyword">in</span> data <span class="keyword">and</span> <span class="string">&#x27;stmt_idx&#x27;</span> <span class="keyword">in</span> data):</span><br><span class="line">                <span class="comment"># this is a hack to work around the issue in Function.normalize() where ins_addr and</span></span><br><span class="line">                <span class="comment"># stmt_idx weren&#x27;t properly set onto edges</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            supernode = supernodes_map[src]</span><br><span class="line">            supernode.register_out_branch(data[<span class="string">&#x27;ins_addr&#x27;</span>], data[<span class="string">&#x27;stmt_idx&#x27;</span>], data[<span class="string">&#x27;type&#x27;</span>], node.addr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> super_graph</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OutBranch</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, ins_addr, stmt_idx, branch_type</span>):</span><br><span class="line">        self.ins_addr = ins_addr</span><br><span class="line">        self.stmt_idx = stmt_idx</span><br><span class="line">        self.<span class="built_in">type</span> = branch_type</span><br><span class="line"></span><br><span class="line">        self.targets = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> self.ins_addr <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&lt;OutBranch at None, type %s&gt;&quot;</span> % self.<span class="built_in">type</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;OutBranch at %#x, type %s&gt;&quot;</span> % (self.ins_addr, self.<span class="built_in">type</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_target</span>(<span class="params">self, addr</span>):</span><br><span class="line">        self.targets.add(addr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Merge with the other OutBranch descriptor.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param OutBranch other: The other item to merge with.</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">assert</span> self.ins_addr == other.ins_addr</span><br><span class="line">        <span class="keyword">assert</span> self.<span class="built_in">type</span> == other.<span class="built_in">type</span></span><br><span class="line"></span><br><span class="line">        o = self.copy()</span><br><span class="line">        o.targets |= other.targets</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> o</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">copy</span>(<span class="params">self</span>):</span><br><span class="line">        o = OutBranch(self.ins_addr, self.stmt_idx, self.<span class="built_in">type</span>)</span><br><span class="line">        o.targets = self.targets.copy()</span><br><span class="line">        <span class="keyword">return</span> o</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__eq__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(other, OutBranch):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.ins_addr == other.ins_addr <span class="keyword">and</span> \</span><br><span class="line">               self.stmt_idx == other.stmt_idx <span class="keyword">and</span> \</span><br><span class="line">               self.<span class="built_in">type</span> == other.<span class="built_in">type</span> <span class="keyword">and</span> \</span><br><span class="line">               self.targets == other.targets</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__hash__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">hash</span>((self.ins_addr, self.stmt_idx, self.<span class="built_in">type</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SuperCFGNode</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, addr</span>):</span><br><span class="line">        self.addr = addr</span><br><span class="line"></span><br><span class="line">        self.cfg_nodes = [ ]</span><br><span class="line"></span><br><span class="line">        self.out_branches = defaultdict(<span class="built_in">dict</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">size</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sum</span>(node.size <span class="keyword">for</span> node <span class="keyword">in</span> self.cfg_nodes)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">from_cfgnode</span>(<span class="params">cls, cfg_node</span>):</span><br><span class="line">        s = cls(cfg_node.addr)</span><br><span class="line"></span><br><span class="line">        s.cfg_nodes.append(cfg_node)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">insert_cfgnode</span>(<span class="params">self, cfg_node</span>):</span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> Make it binary search/insertion</span></span><br><span class="line">        <span class="keyword">for</span> i, n <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.cfg_nodes):</span><br><span class="line">            <span class="keyword">if</span> cfg_node.addr &lt; n.addr:</span><br><span class="line">                <span class="comment"># insert before n</span></span><br><span class="line">                self.cfg_nodes.insert(i, cfg_node)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span> cfg_node.addr == n.addr:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.cfg_nodes.append(cfg_node)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># update addr</span></span><br><span class="line">        self.addr = self.cfg_nodes[<span class="number">0</span>].addr</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register_out_branch</span>(<span class="params">self, ins_addr, stmt_idx, branch_type, target_addr</span>):</span><br><span class="line">        <span class="keyword">if</span> ins_addr <span class="keyword">not</span> <span class="keyword">in</span> self.out_branches <span class="keyword">or</span> stmt_idx <span class="keyword">not</span> <span class="keyword">in</span> self.out_branches[ins_addr]:</span><br><span class="line">            self.out_branches[ins_addr][stmt_idx] = OutBranch(ins_addr, stmt_idx, branch_type)</span><br><span class="line"></span><br><span class="line">        self.out_branches[ins_addr][stmt_idx].add_target(target_addr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Merge another supernode into the current one.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        :param SuperCFGNode other: The supernode to merge with.</span></span><br><span class="line"><span class="string">        :return: None</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> other.cfg_nodes:</span><br><span class="line">            self.insert_cfgnode(n)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> ins_addr, outs <span class="keyword">in</span> other.out_branches.items():</span><br><span class="line">            <span class="keyword">if</span> ins_addr <span class="keyword">in</span> self.out_branches:</span><br><span class="line">                <span class="keyword">for</span> stmt_idx, item <span class="keyword">in</span> outs.items():</span><br><span class="line">                    <span class="keyword">if</span> stmt_idx <span class="keyword">in</span> self.out_branches[ins_addr]:</span><br><span class="line">                        self.out_branches[ins_addr][stmt_idx].merge(item)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        self.out_branches[ins_addr][stmt_idx] = item</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                item = <span class="built_in">next</span>(<span class="built_in">iter</span>(outs.values()))</span><br><span class="line">                self.out_branches[ins_addr][item.stmt_idx] = item</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&lt;SuperCFGNode %#08x, %d blocks, %d out branches&gt;&quot;</span> % (self.addr, <span class="built_in">len</span>(self.cfg_nodes),</span><br><span class="line">                                                                     <span class="built_in">len</span>(self.out_branches)</span><br><span class="line">                                                                     )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__hash__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">hash</span>((<span class="string">&#x27;supercfgnode&#x27;</span>, self.addr))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__eq__</span>(<span class="params">self, other</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(other, SuperCFGNode):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.addr == other.addr</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>去混淆脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">st = <span class="number">0x0000000000400620</span> </span><br><span class="line">end = <span class="number">0x0000000000402144</span> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">next_instr</span>(<span class="params">addr</span>):</span><br><span class="line">    <span class="keyword">return</span> addr+idc.get_item_size(addr)		<span class="comment">#获取指令或数据长度，这个函数的作用就是去往下一条指令</span></span><br><span class="line">    </span><br><span class="line">addr = st</span><br><span class="line"><span class="keyword">while</span>(addr&lt;end):</span><br><span class="line">    <span class="built_in">next</span> = next_instr(addr)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;ds:dword_603054&quot;</span> <span class="keyword">in</span> GetDisasm(addr):	<span class="comment">#GetDisasm(addr)得到addr的反汇编语句</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">            addr = <span class="built_in">next</span></span><br><span class="line">            <span class="built_in">next</span> = next_instr(addr)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;jnz&quot;</span> <span class="keyword">in</span> GetDisasm(addr):</span><br><span class="line">                dest = idc.get_operand_value(addr, <span class="number">0</span>)		<span class="comment">#得到操作数，就是指令后的数</span></span><br><span class="line">                ida_bytes.patch_byte(addr, <span class="number">0xe9</span>)     <span class="comment">#0xe9 jmp后面的四个字节是偏移</span></span><br><span class="line">                ida_bytes.patch_byte(addr+<span class="number">5</span>, <span class="number">0x90</span>)   <span class="comment">#nop第五个字节</span></span><br><span class="line">                offset = dest - (addr + <span class="number">5</span>)  <span class="comment">#调整为正确的偏移地址 也就是相对偏移地址 - 当前指令后的地址</span></span><br><span class="line">                ida_bytes.patch_dword(addr + <span class="number">1</span>, offset) <span class="comment">#把地址赋值给jmp后</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;patch bcf: 0x%x&quot;</span>%addr)</span><br><span class="line">                addr = <span class="built_in">next</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        addr = <span class="built_in">next</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>解密脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">secret = [<span class="number">0xBC8FF26D43536296</span>, <span class="number">0x520100780530EE16</span>, <span class="number">0x4DC0B5EA935F08EC</span>,</span><br><span class="line">          <span class="number">0x342B90AFD853F450</span>, <span class="number">0x8B250EBCAA2C3681</span>, <span class="number">0x55759F81A2C68AE4</span>]</span><br><span class="line">key = <span class="number">0xB0004B7679FA26B3</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 产生CRC32查表法所用的表</span></span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> secret:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>):</span><br><span class="line">        sign = s &amp; <span class="number">1</span>                   <span class="comment">#判断首位正负</span></span><br><span class="line">        <span class="keyword">if</span> sign == <span class="number">1</span>:</span><br><span class="line">            s ^= key</span><br><span class="line">        s //= <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> sign == <span class="number">1</span>:</span><br><span class="line">            s |= <span class="number">0x8000000000000000</span>    <span class="comment"># 防止负值除2，溢出为正值</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(s))                      <span class="comment"># 输出表</span></span><br><span class="line">    <span class="comment"># 计算CRC64</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> j &lt; <span class="number">8</span>:</span><br><span class="line">        flag += <span class="built_in">chr</span>(s&amp;<span class="number">0xFF</span>)</span><br><span class="line">        s &gt;&gt;= <span class="number">8</span></span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/03/31/Flat/" data-id="clfwpfz5m000avws46i7w3l4c" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Buuctf-RE" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/03/31/Buuctf-RE/" class="article-date">
  <time class="dt-published" datetime="2023-03-31T11:04:13.815Z" itemprop="datePublished">2023-03-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="网鼎杯-2020-青龙组-jocker"><a href="#网鼎杯-2020-青龙组-jocker" class="headerlink" title="[网鼎杯 2020 青龙组]jocker"></a>[网鼎杯 2020 青龙组]jocker</h2><ol>
<li>exe文件，32位无壳，拖入IDA32</li>
<li>ctrl+f12定位主体函数，修改变量名提高可读性</li>
<li>F5反汇编发现提示栈错误，option调出栈指针，修改栈指针为0，重新F5</li>
<li>查看输入，24位字符串，主体：复制-&gt;加密-&gt;校对-&gt;encypt函数-&gt;final函数</li>
<li>发现wrong函数加密，omg函数校对，简单异或解密，提交错误，为障眼法（但是得到了正确的输入字符串）</li>
<li>wrong函数上方对输入的flag进行了复制，真正处理的是复制后的flag</li>
<li>找到相应的加密函数encypt，结果是动态加密函数，无法直接F5</li>
<li>exe拖入OD，找到调用加密函数地址，下断点，输入正确字符串运行</li>
<li>F7单步进入加密函数，ODdump脱壳，生成新文件</li>
<li>新文件拖入IDA，查看encypt函数，异或解密得到前19位flag</li>
<li>还剩最后5位，只剩final函数，未知加密，提示是隐藏，推断和之前加密方式相同，为异或加密</li>
<li>利用最后一位”}”推断出异或key，进行解密得到正确flag</li>
</ol>
<blockquote>
<p>核心：修改由于后续动态加密造成的栈指针错位，解密正确输入，OD动态加密脱壳</p>
</blockquote>
<h2 id="SWPU2019-EasiestRe"><a href="#SWPU2019-EasiestRe" class="headerlink" title="[SWPU2019]EasiestRe"></a>[SWPU2019]EasiestRe</h2><ol>
<li>拖入exeinfope，32位无壳，进IDA</li>
<li>ctrl+f找到main函数发现GetThreadContext、SetThreadContext等等函数，多线程没跑了，先放一边</li>
<li>ctrl+f12字符串查找flag找到主体函数(交叉引用)，修改变量名提高可读性</li>
<li>F5反编发现__debugbreak()，int3断点，可以准备改二进制了，继续查看还不止一个</li>
<li>重新看线程，是个父子线程保护，子线程加密，查看函数捕获重要长数组v16、v15</li>
<li>所以又是动态加密，返回__debugbreak()处tab看汇编，int3+nop的长度和v16对的上，那就把v16搬过去，改二进制，重新反编</li>
<li>观察主体函数：输入-&gt;加密-&gt;check-&gt;输出</li>
<li>进入加密，又有__debugbreak()，和上面一样的方式，用v15改二进制码，反编</li>
<li>进入check函数，tab查看汇编，408638地址处发现“cmp [ebp+var_20], 18h”校对指令</li>
<li>查看对应地址，找到校对字符串（即加密结果）</li>
<li>返回加密函数，分析，三次加密(异或–&gt;分段–&gt;移位)</li>
<li>逆写解密</li>
</ol>
<p>核心：双线程保护系统，int3断点(0xcc)，二进制修改</p>
<h2 id="WMCTF2020-easy-re"><a href="#WMCTF2020-easy-re" class="headerlink" title="[WMCTF2020]easy_re"></a>[WMCTF2020]easy_re</h2><ul>
<li>perl处理：一种解释语言，运行时解压，动调处理<ul>
<li>搜索script关键词，找到perl脚本调用处</li>
<li>再关键点下面设断点，F8运行到脚本执行完毕</li>
<li>下一个eax中可见原文</li>
</ul>
</li>
</ul>
<h2 id="BJDCTF2020-hamburger-competition"><a href="#BJDCTF2020-hamburger-competition" class="headerlink" title="[BJDCTF2020]hamburger competition"></a>[BJDCTF2020]hamburger competition</h2><ul>
<li><p>一个unity游戏逆向问题</p>
</li>
<li><p>工具：dnspy</p>
</li>
<li><p>核心代码一般路径：</p>
<blockquote>
<p>\TPH\TPH_Data\Managed\Assembly-CSharp.dll</p>
</blockquote>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/03/31/Buuctf-RE/" data-id="clfwpfz5k0006vws4dokfdyia" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Note3" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/03/31/Note3/" class="article-date">
  <time class="dt-published" datetime="2023-03-31T11:03:42.980Z" itemprop="datePublished">2023-03-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="DLL文件"><a href="#DLL文件" class="headerlink" title="DLL文件"></a>DLL文件</h2><ul>
<li>（Dynamic Link Library）动态链接库</li>
<li>目的：解决在多进程时一个系统API可能会被多次调用，多次加载到内存造成空间浪费的问题</li>
<li>描述：<ul>
<li>库封装，单独组成DLL文件</li>
<li>内存映射技术，实现多进程共享同一个文件</li>
<li>更新库时替换对应DLL文件</li>
</ul>
</li>
<li>加载方式：<ul>
<li>显式链接：使用时加载，用完后释放内存</li>
<li>隐式链接：加载程序时将DLL全部加载，程序终止后释放内存</li>
</ul>
</li>
</ul>
<h2 id="节区删除"><a href="#节区删除" class="headerlink" title="节区删除"></a>节区删除</h2><ol>
<li>删除节区头，PEview中查看节区头起始地址及长度，在hex编辑器中将该区域用0覆盖</li>
<li>删除节区，查看节区起始偏移及长度，hex编辑器中删除</li>
<li>修改IMAGE_FILE_HEADER[Number Of Sections -&#x3D; 1]</li>
<li>修改IMAGE_OPTIONAL_HEADER[Size Of Image减少对应长度]</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/03/31/Note3/" data-id="clfwpfz5p000fvws4d5yg5jzs" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Note2" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/03/31/Note2/" class="article-date">
  <time class="dt-published" datetime="2023-03-31T11:03:18.273Z" itemprop="datePublished">2023-03-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="PE文件格式"><a href="#PE文件格式" class="headerlink" title="PE文件格式"></a>PE文件格式</h1><h2 id="种类"><a href="#种类" class="headerlink" title="种类"></a>种类</h2><table>
<thead>
<tr>
<th>种类</th>
<th>主扩展名</th>
</tr>
</thead>
<tbody><tr>
<td>可执行系列</td>
<td>EXE，SCR</td>
</tr>
<tr>
<td>库系列</td>
<td>DLL，OCX，CPL，DRV</td>
</tr>
<tr>
<td>驱动程序系列</td>
<td>SYS，VXD</td>
</tr>
<tr>
<td>对象文件系列</td>
<td>OBJ</td>
</tr>
</tbody></table>
<h2 id="零碎点"><a href="#零碎点" class="headerlink" title="零碎点"></a>零碎点</h2><ol>
<li>PE文件分PE头与PE体</li>
<li>PE头由各种结构体构成，说明了文件大小、执行地址等等信息，PE体分多个节区，如代码段、数据段、资源段等。</li>
<li>PE文件在内存中和在磁盘中大小不同</li>
<li>RVA(相对虚拟地址) VA(虚拟内存绝对地址) RAW(文件偏移)</li>
</ol>
<h2 id="PE头分解"><a href="#PE头分解" class="headerlink" title="PE头分解"></a>PE头分解</h2><h3 id="DOS头"><a href="#DOS头" class="headerlink" title="DOS头"></a>DOS头</h3><p>核心参数：</p>
<ul>
<li>e_magic:DOS签名，“MZ”（DOS可执行文件设计者）</li>
<li>e_lfanew:指示NT头的偏移</li>
</ul>
<h3 id="DOS存根"><a href="#DOS存根" class="headerlink" title="DOS存根"></a>DOS存根</h3><p>一个可忽略项，可理解为DOS下执行的数据</p>
<blockquote>
<p>例如notepad.exe中的提示语:This program cannot be run in DOS mode</p>
</blockquote>
<h3 id="NT头"><a href="#NT头" class="headerlink" title="NT头"></a>NT头</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _IMAGE_NT_HEADERS &#123;</span><br><span class="line">    DWORD Signature;                             //签名“PE”</span><br><span class="line">    IMAGE_FILE_HEADER FileHeader;                //文件头</span><br><span class="line">    IMAGE_OPTIONAL_HEADER32 OptionalHeader;      //可选头</span><br><span class="line">&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;</span><br></pre></td></tr></table></figure>

<h4 id="文件头"><a href="#文件头" class="headerlink" title="文件头"></a>文件头</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _IMAGE_FILE_HEADER &#123;</span><br><span class="line">    WORD    Machine;                  //机器码（每种CPU都有各自的固定值，如intel x86的14C）</span><br><span class="line">    WORD    NumberOfSections;         //节区数量</span><br><span class="line">    DWORD   TimeDateStamp;</span><br><span class="line">    DWORD   PointerToSymbolTable;</span><br><span class="line">    DWORD   NumberOfSymbols;</span><br><span class="line">    WORD    SizeOfOptionalHeader;     //指示可选头的大小</span><br><span class="line">    WORD    Characteristics;          //标识文件属性（是否为DLL等等）</span><br><span class="line">&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER</span><br></pre></td></tr></table></figure>

<h4 id="可选头-直接把64位的搬过来了"><a href="#可选头-直接把64位的搬过来了" class="headerlink" title="可选头(直接把64位的搬过来了)"></a>可选头(直接把64位的搬过来了)</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">typedef struct _IMAGE_OPTIONAL_HEADER64 &#123;</span><br><span class="line">    WORD        Magic;                       //32-10B， 64-20B</span><br><span class="line">    BYTE        MajorLinkerVersion;          </span><br><span class="line">    BYTE        MinorLinkerVersion;</span><br><span class="line">    DWORD       SizeOfCode;</span><br><span class="line">    DWORD       SizeOfInitializedData;</span><br><span class="line">    DWORD       SizeOfUninitializedData;</span><br><span class="line">    DWORD       AddressOfEntryPoint;         //PE的RVA值，指出代码起始位置</span><br><span class="line">    DWORD       BaseOfCode;</span><br><span class="line">    ULONGLONG   ImageBase;                   //基准，VA = RVA + ImageBase</span><br><span class="line">    DWORD       SectionAlignment;            //节区内存最小单位</span><br><span class="line">    DWORD       FileAlignment;               //节区磁盘最小单位</span><br><span class="line">    WORD        MajorOperatingSystemVersion;</span><br><span class="line">    WORD        MinorOperatingSystemVersion;</span><br><span class="line">    WORD        MajorImageVersion;</span><br><span class="line">    WORD        MinorImageVersion;</span><br><span class="line">    WORD        MajorSubsystemVersion;</span><br><span class="line">    WORD        MinorSubsystemVersion;</span><br><span class="line">    DWORD       Win32VersionValue;</span><br><span class="line">    DWORD       SizeOfImage;                 //指定在虚拟内存中所占空间大小</span><br><span class="line">    DWORD       SizeOfHeaders;               //PE头大小（第一节区所在位置与该值距文件开始偏移量相同）</span><br><span class="line">    DWORD       CheckSum;</span><br><span class="line">    WORD        Subsystem;                   //区分文件</span><br><span class="line">                                              1 Driver文件（系统驱动）</span><br><span class="line">                                              2 GUI文件（窗口应用程序）</span><br><span class="line">                                              3 CUI文件（控制台应用程序）</span><br><span class="line">    WORD        DllCharacteristics;</span><br><span class="line">    ULONGLONG   SizeOfStackReserve;</span><br><span class="line">    ULONGLONG   SizeOfStackCommit;</span><br><span class="line">    ULONGLONG   SizeOfHeapReserve;</span><br><span class="line">    ULONGLONG   SizeOfHeapCommit;</span><br><span class="line">    DWORD       LoaderFlags;</span><br><span class="line">    DWORD       NumberOfRvaAndSizes;         //</span><br><span class="line">    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];</span><br><span class="line">&#125; IMAGE_OPTIONAL_HEADER64, *PIMAGE_OPTIONAL_HEADER64;</span><br></pre></td></tr></table></figure>

<h3 id="节区头"><a href="#节区头" class="headerlink" title="节区头"></a>节区头</h3><h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><table>
<thead>
<tr>
<th>类别</th>
<th>访问权限</th>
</tr>
</thead>
<tbody><tr>
<td>code</td>
<td>执行，读取权限</td>
</tr>
<tr>
<td>data</td>
<td>非执行，读写权限</td>
</tr>
<tr>
<td>resource</td>
<td>非执行，读取权限</td>
</tr>
</tbody></table>
<h4 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#define IMAGE_SIZEOF_SHORT_NAME              8</span><br><span class="line"></span><br><span class="line">typedef struct _IMAGE_SECTION_HEADER &#123;</span><br><span class="line">    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];</span><br><span class="line">    union &#123;</span><br><span class="line">            DWORD   PhysicalAddress;</span><br><span class="line">            DWORD   VirtualSize;            //内存中节区大小</span><br><span class="line">    &#125; Misc;</span><br><span class="line">    DWORD   VirtualAddress;                 //内存中节区起始地址（RVA）</span><br><span class="line">    DWORD   SizeOfRawData;                  //磁盘中节区大小</span><br><span class="line">    DWORD   PointerToRawData;               //磁盘中节区起始地址</span><br><span class="line">    DWORD   PointerToRelocations;</span><br><span class="line">    DWORD   PointerToLinenumbers;</span><br><span class="line">    WORD    NumberOfRelocations;</span><br><span class="line">    WORD    NumberOfLinenumbers;</span><br><span class="line">    DWORD   Characteristics;                //节区属性</span><br><span class="line">&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure>

<h2 id="计算"><a href="#计算" class="headerlink" title="计算"></a>计算</h2><ul>
<li>RAW &#x3D; RVA - (VA)VirtualAddress + PointerToRawData</li>
</ul>
<h1 id="附表："><a href="#附表：" class="headerlink" title="附表："></a>附表：</h1><h2 id="DataDirectory结构体数组-64-01239为重点"><a href="#DataDirectory结构体数组-64-01239为重点" class="headerlink" title="DataDirectory结构体数组(64)[01239为重点]"></a>DataDirectory结构体数组(64)[01239为重点]</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#define IMAGE_DIRECTORY_ENTRY_EXPORT          0   // Export Directory</span><br><span class="line">#define IMAGE_DIRECTORY_ENTRY_IMPORT          1   // Import Directory</span><br><span class="line">#define IMAGE_DIRECTORY_ENTRY_RESOURCE        2   // Resource Directory</span><br><span class="line">#define IMAGE_DIRECTORY_ENTRY_EXCEPTION       3   // Exception Directory</span><br><span class="line">#define IMAGE_DIRECTORY_ENTRY_SECURITY        4   // Security Directory</span><br><span class="line">#define IMAGE_DIRECTORY_ENTRY_BASERELOC       5   // Base Relocation Table</span><br><span class="line">#define IMAGE_DIRECTORY_ENTRY_DEBUG           6   // Debug Directory</span><br><span class="line">        IMAGE_DIRECTORY_ENTRY_COPYRIGHT       7   // (X86 usage)</span><br><span class="line">#define IMAGE_DIRECTORY_ENTRY_ARCHITECTURE    7   // Architecture Specific Data</span><br><span class="line">#define IMAGE_DIRECTORY_ENTRY_GLOBALPTR       8   // RVA of GP</span><br><span class="line">#define IMAGE_DIRECTORY_ENTRY_TLS             9   // TLS Directory</span><br><span class="line">#define IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG    10   // Load Configuration Directory</span><br><span class="line">#define IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT   11   // Bound Import Directory in headers</span><br><span class="line">#define IMAGE_DIRECTORY_ENTRY_IAT            12   // Import Address Table</span><br><span class="line">#define IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT   13   // Delay Load Import Descriptors</span><br><span class="line">#define IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR 14   // COM Runtime descriptor</span><br></pre></td></tr></table></figure>

<h2 id="Machine值"><a href="#Machine值" class="headerlink" title="Machine值"></a>Machine值</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#define IMAGE_FILE_MACHINE_UNKNOWN           0</span><br><span class="line">#define IMAGE_FILE_MACHINE_I386              0x014c  // Intel 386.</span><br><span class="line">#define IMAGE_FILE_MACHINE_R3000             0x0162  // MIPS little-endian, 0x160 big-endian</span><br><span class="line">#define IMAGE_FILE_MACHINE_R4000             0x0166  // MIPS little-endian</span><br><span class="line">#define IMAGE_FILE_MACHINE_R10000            0x0168  // MIPS little-endian</span><br><span class="line">#define IMAGE_FILE_MACHINE_WCEMIPSV2         0x0169  // MIPS little-endian WCE v2</span><br><span class="line">#define IMAGE_FILE_MACHINE_ALPHA             0x0184  // Alpha_AXP</span><br><span class="line">#define IMAGE_FILE_MACHINE_SH3               0x01a2  // SH3 little-endian</span><br><span class="line">#define IMAGE_FILE_MACHINE_SH3DSP            0x01a3</span><br><span class="line">#define IMAGE_FILE_MACHINE_SH3E              0x01a4  // SH3E little-endian</span><br><span class="line">#define IMAGE_FILE_MACHINE_SH4               0x01a6  // SH4 little-endian</span><br><span class="line">#define IMAGE_FILE_MACHINE_SH5               0x01a8  // SH5</span><br><span class="line">#define IMAGE_FILE_MACHINE_ARM               0x01c0  // ARM Little-Endian</span><br><span class="line">#define IMAGE_FILE_MACHINE_THUMB             0x01c2</span><br><span class="line">#define IMAGE_FILE_MACHINE_AM33              0x01d3</span><br><span class="line">#define IMAGE_FILE_MACHINE_POWERPC           0x01F0  // IBM PowerPC Little-Endian</span><br><span class="line">#define IMAGE_FILE_MACHINE_POWERPCFP         0x01f1</span><br><span class="line">#define IMAGE_FILE_MACHINE_IA64              0x0200  // Intel 64</span><br><span class="line">#define IMAGE_FILE_MACHINE_MIPS16            0x0266  // MIPS</span><br><span class="line">#define IMAGE_FILE_MACHINE_ALPHA64           0x0284  // ALPHA64</span><br><span class="line">#define IMAGE_FILE_MACHINE_MIPSFPU           0x0366  // MIPS</span><br><span class="line">#define IMAGE_FILE_MACHINE_MIPSFPU16         0x0466  // MIPS</span><br><span class="line">#define IMAGE_FILE_MACHINE_AXP64             IMAGE_FILE_MACHINE_ALPHA64</span><br><span class="line">#define IMAGE_FILE_MACHINE_TRICORE           0x0520  // Infineon</span><br><span class="line">#define IMAGE_FILE_MACHINE_CEF               0x0CEF</span><br><span class="line">#define IMAGE_FILE_MACHINE_EBC               0x0EBC  // EFI Byte Code</span><br><span class="line">#define IMAGE_FILE_MACHINE_AMD64             0x8664  // AMD64 (K8)</span><br><span class="line">#define IMAGE_FILE_MACHINE_M32R              0x9041  // M32R little-endian</span><br><span class="line">#define IMAGE_FILE_MACHINE_CEE               0xC0EE</span><br></pre></td></tr></table></figure>

<h2 id="Characteristics值"><a href="#Characteristics值" class="headerlink" title="Characteristics值"></a>Characteristics值</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#define IMAGE_FILE_RELOCS_STRIPPED           0x0001  // Relocation info stripped from file.</span><br><span class="line">#define IMAGE_FILE_EXECUTABLE_IMAGE          0x0002  // File is executable  (i.e. no unresolved externel references).</span><br><span class="line">#define IMAGE_FILE_LINE_NUMS_STRIPPED        0x0004  // Line nunbers stripped from file.</span><br><span class="line">#define IMAGE_FILE_LOCAL_SYMS_STRIPPED       0x0008  // Local symbols stripped from file.</span><br><span class="line">#define IMAGE_FILE_AGGRESIVE_WS_TRIM         0x0010  // Agressively trim working set</span><br><span class="line">#define IMAGE_FILE_LARGE_ADDRESS_AWARE       0x0020  // App can handle &gt;2gb addresses</span><br><span class="line">#define IMAGE_FILE_BYTES_REVERSED_LO         0x0080  // Bytes of machine word are reversed.</span><br><span class="line">#define IMAGE_FILE_32BIT_MACHINE             0x0100  // 32 bit word machine.</span><br><span class="line">#define IMAGE_FILE_DEBUG_STRIPPED            0x0200  // Debugging info stripped from file in .DBG file</span><br><span class="line">#define IMAGE_FILE_REMOVABLE_RUN_FROM_SWAP   0x0400  // If Image is on removable media, copy and run from the swap file.</span><br><span class="line">#define IMAGE_FILE_NET_RUN_FROM_SWAP         0x0800  // If Image is on Net, copy and run from the swap file.</span><br><span class="line">#define IMAGE_FILE_SYSTEM                    0x1000  // System File.</span><br><span class="line">#define IMAGE_FILE_DLL                       0x2000  // File is a DLL.</span><br><span class="line">#define IMAGE_FILE_UP_SYSTEM_ONLY            0x4000  // File should only be run on a UP machine</span><br><span class="line">#define IMAGE_FILE_BYTES_REVERSED_HI         0x8000  // Bytes of machine word are reversed.</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/03/31/Note2/" data-id="clfwpfz5o000evws45s7a7ptb" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Z3" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/03/31/Z3/" class="article-date">
  <time class="dt-published" datetime="2023-03-31T11:02:27.842Z" itemprop="datePublished">2023-03-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><blockquote>
<p>直接搞到网盘上用链接吧：<br>链接：(<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1gni_eYUC-Y_dQVogJh9QyA?pwd=1234">https://pan.baidu.com/s/1gni_eYUC-Y_dQVogJh9QyA?pwd=1234</a>)<br>提取码：1234</p>
</blockquote>
<ol>
<li>下载解压</li>
<li>将文件中bin目录配置到系统变量path中</li>
<li>新建PYTHONPATH系统变量，路径为bin&#x2F;python目录</li>
</ol>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><ol>
<li>打开黑框框</li>
</ol>
<blockquote>
<p>cmd到bin&#x2F;python的目录</p>
</blockquote>
<p>or</p>
<blockquote>
<p>在bin&#x2F;python目录下shift右键powershell</p>
</blockquote>
<ol>
<li>输入python</li>
<li>把代码输进去回车就完了</li>
</ol>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><ul>
<li><p>先看官方示例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from z3 import *</span><br><span class="line">x = Real(&#x27;x&#x27;)</span><br><span class="line">y = Real(&#x27;y&#x27;)</span><br><span class="line">s = Solver()</span><br><span class="line">s.add(x + y &gt; 5, x &gt; 1, y &gt; 1)</span><br><span class="line">print(s.check())</span><br><span class="line">print(s.model())</span><br></pre></td></tr></table></figure>
</li>
<li><p>简单说一下</p>
</li>
</ul>
<ol>
<li>导包z3</li>
<li>a &#x3D; Real(b), a为方程中的未知数，b为输出时候用来表示a的变量</li>
<li>Solver()，简言之：解决函数，方程接收器</li>
<li>add()，括号里塞方程就行，用“,”隔开，或者你多用几个add()也行</li>
<li>后面俩不用动了，就那样</li>
<li>回车出结果</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/03/31/Z3/" data-id="clfwpfz5q000jvws4eye0g3dx" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Pyc" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/03/31/Pyc/" class="article-date">
  <time class="dt-published" datetime="2023-03-31T11:02:04.211Z" itemprop="datePublished">2023-03-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="2022-x2F-10-x2F-25-重写"><a href="#2022-x2F-10-x2F-25-重写" class="headerlink" title="2022&#x2F;10&#x2F;25 重写"></a>2022&#x2F;10&#x2F;25 重写</h2><ul>
<li><p>加一个内容：exe到pyc的转化</p>
<ul>
<li>可操作exe的识别（用python编译生成的exe文件一般来讲会比较大）</li>
<li>具体处理（利用脚本完成）</li>
</ul>
</li>
<li><p>py脚本（pyinstxtractor）</p>
<p>（<a target="_blank" rel="noopener" href="https://gitcode.net/mirrors/extremecoders-re/pyinstxtractor?utm_source=csdn_github_accelerator">mirrors &#x2F; extremecoders-re &#x2F; pyinstxtractor · GitCode</a>）</p>
</li>
<li><p>使用</p>
<ul>
<li><p>建议官方文档readme.md</p>
</li>
<li><p>比较常见的操作就是将要转化的exe程序复制到脚本文件目录下，执行命令</p>
<blockquote>
<p>python pyinstxtractor.py test.exe</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="pyc文件反编"><a href="#pyc文件反编" class="headerlink" title="pyc文件反编"></a>pyc文件反编</h3><p>py生成的中间文件</p>
<blockquote>
<p>先省略无数字，需要深入了解底层再说</p>
</blockquote>
<h3 id="处理"><a href="#处理" class="headerlink" title="处理"></a>处理</h3><ul>
<li><p>借用外部资源，安装uncompyle6</p>
<blockquote>
<p>pip install uncompyle</p>
</blockquote>
</li>
<li><p>使用</p>
<blockquote>
<p>uncompyle6 name.pyc &gt; name.py</p>
</blockquote>
</li>
<li><p>或者直接用网上的在线反编译：<br>(<a target="_blank" rel="noopener" href="https://tool.lu/pyc/">https://tool.lu/pyc/</a>)</p>
</li>
</ul>
<blockquote>
<p>因为比较bug的一件事情是：<br>我遇到了某pyc文件用uncompyle6无法反编的情况，目前推测应该是版本不对的问题<br>后续再研究研究</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/03/31/Pyc/" data-id="clfwpfz5p000gvws47e2h0nkc" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-IDA" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/03/31/IDA/" class="article-date">
  <time class="dt-published" datetime="2023-03-31T11:01:24.587Z" itemprop="datePublished">2023-03-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="快捷操作"><a href="#快捷操作" class="headerlink" title="快捷操作"></a>快捷操作</h2><table>
<thead>
<tr>
<th>操作</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>F5</td>
<td>反汇编</td>
</tr>
<tr>
<td>函数列表Ctrl+F</td>
<td>搜索函数</td>
</tr>
<tr>
<td>X</td>
<td>交叉引用</td>
</tr>
<tr>
<td>G</td>
<td>跳转到指定地址</td>
</tr>
<tr>
<td>Shift+F12</td>
<td>字符串列表</td>
</tr>
<tr>
<td>Alt+T</td>
<td>按指令查找</td>
</tr>
<tr>
<td>N</td>
<td>重命名(函数名等)</td>
</tr>
<tr>
<td>Ctrl+Z</td>
<td>操作撤销</td>
</tr>
<tr>
<td>D</td>
<td>将字符串等元素转为数据</td>
</tr>
<tr>
<td>A</td>
<td>将数据转变为字符串</td>
</tr>
<tr>
<td>C</td>
<td>将数据转变为汇编代码</td>
</tr>
<tr>
<td>U</td>
<td>将字符串转变为原始数据</td>
</tr>
<tr>
<td>Shift+E</td>
<td>导出数据</td>
</tr>
<tr>
<td>Shift+F2</td>
<td>脚本嵌入</td>
</tr>
<tr>
<td>;</td>
<td>添加注释(所有交叉参考处均显示)</td>
</tr>
<tr>
<td>:</td>
<td>添加注释(仅在此处显示)</td>
</tr>
<tr>
<td>Esc</td>
<td>后退一步</td>
</tr>
<tr>
<td>Ctrl+Enter</td>
<td>前进一步</td>
</tr>
<tr>
<td>Alt+M</td>
<td>标记当前位置</td>
</tr>
<tr>
<td>Ctrl+M</td>
<td>跳转到标记位置</td>
</tr>
<tr>
<td>P</td>
<td>创建函数</td>
</tr>
</tbody></table>
<h2 id="elf调试"><a href="#elf调试" class="headerlink" title="elf调试"></a>elf调试</h2><ul>
<li>将linux_server&#x2F;64复制到kali运行</li>
<li>ida设置调试</li>
</ul>
<h2 id="so调试"><a href="#so调试" class="headerlink" title="so调试"></a>so调试</h2><ul>
<li>将android_server复制到安卓环境中（模拟器 or 测试机）</li>
<li>chmod 777 android_server并运行</li>
<li>adb forward将调试端口转移到本机</li>
<li>将so文件所在apk以debug模式启动</li>
<li>IDA打开要调试的文件，附加apk进程</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/03/31/IDA/" data-id="clfwpfz5o000cvws4cjkvdqmj" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Tea" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/03/31/Tea/" class="article-date">
  <time class="dt-published" datetime="2023-03-31T11:00:12.934Z" itemprop="datePublished">2023-03-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ul>
<li>一写题就是变种xxtea，我已经无语了</li>
<li>茶类算法一般来讲顺序逆写加密代码即可</li>
<li>代码基于网络开源代码修改，侵删</li>
</ul>
<h2 id="Tea"><a href="#Tea" class="headerlink" title="Tea"></a>Tea</h2><h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><ul>
<li>delta常数：0x9e3779b9</li>
<li>key：4个32位无符号整数</li>
<li>v：2个32位无符号整数</li>
</ul>
<h4 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h4><ul>
<li>利用key和delta对数据进行32轮简单和加密</li>
<li>特征：<ul>
<li>三异或</li>
<li>4、5移位</li>
</ul>
</li>
</ul>
<h4 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">encrypt</span> <span class="params">(<span class="type">uint32_t</span>* v, <span class="type">uint32_t</span>* k)</span> </span>&#123;  </span><br><span class="line">    <span class="type">uint32_t</span> delta=<span class="number">0x9e3779b9</span>;</span><br><span class="line">    <span class="type">uint32_t</span> v0 = v[<span class="number">0</span>], v1 = v[<span class="number">1</span>], sum = <span class="number">0</span>;               </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;                      </span><br><span class="line">        sum += delta;  </span><br><span class="line">        v0 += ((v1&lt;&lt;<span class="number">4</span>) + k[<span class="number">0</span>]) ^ (v1 + sum) ^ ((v1&gt;&gt;<span class="number">5</span>) + k[<span class="number">1</span>]);  </span><br><span class="line">        v1 += ((v0&lt;&lt;<span class="number">4</span>) + k[<span class="number">2</span>]) ^ (v0 + sum) ^ ((v0&gt;&gt;<span class="number">5</span>) + k[<span class="number">3</span>]);  </span><br><span class="line">    &#125;                                                </span><br><span class="line">    v[<span class="number">0</span>] = v0; </span><br><span class="line">    v[<span class="number">1</span>] = v1;  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h4 id="解密"><a href="#解密" class="headerlink" title="解密"></a>解密</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">decrypt</span> <span class="params">(<span class="type">uint32_t</span>* v, <span class="type">uint32_t</span>* k)</span> </span>&#123;  </span><br><span class="line">    <span class="type">uint32_t</span> delta = <span class="number">0x9e3779b9</span>; </span><br><span class="line">	<span class="type">uint32_t</span> sum = <span class="number">0xc6ef3720</span>     <span class="comment">//sum = delta*32 = 0x13c6ef3720，取32位，高位数据溢出 </span></span><br><span class="line">    <span class="type">uint32_t</span> v0 = v[<span class="number">0</span>], v1 = v[<span class="number">1</span>]; </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;                         </span><br><span class="line">        v1 -= ((v0&lt;&lt;<span class="number">4</span>) + k[<span class="number">2</span>]) ^ (v0 + sum) ^ ((v0&gt;&gt;<span class="number">5</span>) + k[<span class="number">3</span>]);  </span><br><span class="line">        v0 -= ((v1&lt;&lt;<span class="number">4</span>) + k[<span class="number">0</span>]) ^ (v1 + sum) ^ ((v1&gt;&gt;<span class="number">5</span>) + k[<span class="number">1</span>]);  </span><br><span class="line">        sum -= delta;  </span><br><span class="line">    &#125;                                            </span><br><span class="line">    v[<span class="number">0</span>] = v0; </span><br><span class="line">    v[<span class="number">1</span>] = v1;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h2 id="xxTea"><a href="#xxTea" class="headerlink" title="xxTea"></a>xxTea</h2><ul>
<li>key和delta如上，加密轮数由数据长度n决定</li>
<li>改魔数的就另当别论，一般解tea都是用c++写</li>
</ul>
<h4 id="c"><a href="#c" class="headerlink" title="c++"></a>c++</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="comment">//常见变化点</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MX (((z&gt;&gt;5^y<span class="string">&lt;&lt;2) + (y&gt;</span>&gt;3^z&lt;&lt;4)) ^ ((sum^y) + (key[(p&amp;3)^e] ^ z)))  </span></span><br><span class="line"><span class="comment">//key定义，4个32位无符号整数</span></span><br><span class="line"><span class="type">const</span> <span class="type">uint32_t</span> key[<span class="number">4</span>] = &#123;&#125;;</span><br><span class="line"><span class="comment">//delta</span></span><br><span class="line"><span class="type">uint32_t</span> delta = <span class="number">0x9E3779B9</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">encrypt</span><span class="params">(<span class="type">uint32_t</span>* flag, <span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">  <span class="type">uint32_t</span> y, z, sum;  </span><br><span class="line">  rounds = <span class="number">52</span> / n + <span class="number">6</span>;</span><br><span class="line">  sum = <span class="number">0</span>;</span><br><span class="line">  z = flag[n - <span class="number">1</span>];</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    sum += delta;</span><br><span class="line">    e = (sum&gt;&gt;<span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; n - <span class="number">1</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      y = flag[i+<span class="number">1</span>];</span><br><span class="line">      z = flag[i] += MX;</span><br><span class="line">    &#125;</span><br><span class="line">    y = flag[<span class="number">0</span>];</span><br><span class="line">    z = flag[n<span class="number">-1</span>] += MX;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (--rounds);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">decrypt</span><span class="params">(<span class="type">uint32_t</span>* flag, <span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">  <span class="type">uint32_t</span> y, z, sum;  </span><br><span class="line">  rounds = <span class="number">52</span> / n + <span class="number">6</span>;</span><br><span class="line">  sum = rounds*delta;</span><br><span class="line">  y = flag[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    e = (sum&gt;&gt;<span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">for</span> ( i = n<span class="number">-1</span>; i &gt; <span class="number">0</span>; i--)</span><br><span class="line">    &#123;</span><br><span class="line">      z = flag[i<span class="number">-1</span>];</span><br><span class="line">      y = flag[i] -= MX;</span><br><span class="line">    &#125;</span><br><span class="line">    z = flag[n<span class="number">-1</span>];</span><br><span class="line">    y = flag[<span class="number">0</span>] -= MX;</span><br><span class="line">    sum -= delta;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (--rounds);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="python"><a href="#python" class="headerlink" title="python"></a>python</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">参数描述:</span></span><br><span class="line"><span class="string">  DELTA: 神秘常数δ，它来源于黄金比率，以保证每一轮加密都不相同。但δ的精确值似乎并不重要，这里 TEA 把它定义为 δ=「(√5 - 1)231」</span></span><br><span class="line"><span class="string">      v: 需要加解密的数据，格式为32位的无符号整数组成的数组</span></span><br><span class="line"><span class="string">      n: n表示需要加密的32位无符号整数的个数（例：n为1时，只有v数组中的第一个元素被加密了），n不能大于v的长度</span></span><br><span class="line"><span class="string">      k: 密钥，格式为4个32位无符号整数组成的数组，即密钥长度为128位</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> c_uint32</span><br><span class="line"> </span><br><span class="line">DELTA = <span class="number">0x9E3779B9</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">v, n, k</span>):</span><br><span class="line">    rounds = <span class="number">6</span> + <span class="built_in">int</span>(<span class="number">52</span> / n)</span><br><span class="line">    <span class="built_in">sum</span> = c_uint32(<span class="number">0</span>)</span><br><span class="line">    z = v[n - <span class="number">1</span>].value</span><br><span class="line">    <span class="keyword">while</span> rounds &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">sum</span>.value += DELTA</span><br><span class="line">        e = (<span class="built_in">sum</span>.value &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span></span><br><span class="line">        p = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> p &lt; n - <span class="number">1</span>:</span><br><span class="line">            y = v[p + <span class="number">1</span>].value</span><br><span class="line">            v[p].value += (((z &gt;&gt; <span class="number">5</span> ^ y &lt;&lt; <span class="number">2</span>) + (y &gt;&gt; <span class="number">3</span> ^ z &lt;&lt; <span class="number">4</span>)) ^ ((<span class="built_in">sum</span>.value ^ y) + (k[(p &amp; <span class="number">3</span>) ^ e] ^ z)))</span><br><span class="line">            z = v[p].value</span><br><span class="line">            p += <span class="number">1</span></span><br><span class="line">        y = v[<span class="number">0</span>].value</span><br><span class="line">        v[n - <span class="number">1</span>].value += (((z &gt;&gt; <span class="number">5</span> ^ y &lt;&lt; <span class="number">2</span>) + (y &gt;&gt; <span class="number">3</span> ^ z &lt;&lt; <span class="number">4</span>)) ^ ((<span class="built_in">sum</span>.value ^ y) + (k[(p &amp; <span class="number">3</span>) ^ e] ^ z)))</span><br><span class="line">        z = v[n - <span class="number">1</span>].value</span><br><span class="line">        rounds -= <span class="number">1</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">v, n, k</span>):</span><br><span class="line">    rounds = <span class="number">6</span> + <span class="built_in">int</span>(<span class="number">52</span> / n)</span><br><span class="line">    <span class="built_in">sum</span> = c_uint32(rounds * DELTA)</span><br><span class="line">    y = v[<span class="number">0</span>].value</span><br><span class="line">    <span class="keyword">while</span> rounds &gt; <span class="number">0</span>:</span><br><span class="line">        e = (<span class="built_in">sum</span>.value &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span></span><br><span class="line">        p = n - <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> p &gt; <span class="number">0</span>:</span><br><span class="line">            z = v[p - <span class="number">1</span>].value</span><br><span class="line">            v[p].value -= (((z &gt;&gt; <span class="number">5</span> ^ y &lt;&lt; <span class="number">2</span>) + (y &gt;&gt; <span class="number">3</span> ^ z &lt;&lt; <span class="number">4</span>)) ^ ((<span class="built_in">sum</span>.value ^ y) + (k[(p &amp; <span class="number">3</span>) ^ e] ^ z)))</span><br><span class="line">            y = v[p].value</span><br><span class="line">            p -= <span class="number">1</span></span><br><span class="line">        z = v[n - <span class="number">1</span>].value</span><br><span class="line">        v[<span class="number">0</span>].value -= (((z &gt;&gt; <span class="number">5</span> ^ y &lt;&lt; <span class="number">2</span>) + (y &gt;&gt; <span class="number">3</span> ^ z &lt;&lt; <span class="number">4</span>)) ^ ((<span class="built_in">sum</span>.value ^ y) + (k[(p &amp; <span class="number">3</span>) ^ e] ^ z)))</span><br><span class="line">        y = v[<span class="number">0</span>].value</span><br><span class="line">        <span class="built_in">sum</span>.value -= DELTA</span><br><span class="line">        rounds -= <span class="number">1</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test1</span>():</span><br><span class="line">    k = [<span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">    v = [c_uint32(<span class="number">1</span>), c_uint32(<span class="number">2</span>)]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;plain: 1 2&#x27;</span>)</span><br><span class="line">    encrypt(v, <span class="built_in">len</span>(v), k)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;encrypted: %X %X&#x27;</span> % (v[<span class="number">0</span>].value, v[<span class="number">1</span>].value))</span><br><span class="line">    decrypt(v, <span class="built_in">len</span>(v), k)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;decrypted: %X %X&#x27;</span> % (v[<span class="number">0</span>].value, v[<span class="number">1</span>].value))</span><br><span class="line"></span><br><span class="line">————————————————</span><br><span class="line">此段代码为转载，原文链接：https://blog.csdn.net/koxb/article/details/<span class="number">120088234</span></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/03/31/Tea/" data-id="clfwpfz5q000ivws4e3c58q2o" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/03/31/Affine/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/03/31/Crypto/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/03/31/Flat/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/03/31/Buuctf-RE/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/03/31/Note3/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>